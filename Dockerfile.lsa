FROM python:3.12-slim

ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    TESSDATA_PREFIX=/usr/share/tesseract-ocr/5/tessdata

# OCR и инструменты PDF
RUN apt-get -yq update && apt-get -yq install --no-install-recommends \
    tesseract-ocr tesseract-ocr-eng tesseract-ocr-rus tesseract-ocr-pol \
    tesseract-ocr-deu tesseract-ocr-ukr tesseract-ocr-spa \
    poppler-utils qpdf git curl \
    && rm -rf /var/lib/apt/lists/*

# Dev-пакеты для сборки некоторых wheels
RUN apt-get -yq update && apt-get -yq install --no-install-recommends \
    build-essential libffi-dev libssl-dev pkg-config \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Устанавливаем Python-зависимости
COPY requirements_rag.txt /app/requirements.txt
RUN python -m pip install --upgrade pip && \
    pip install --no-cache-dir -r /app/requirements.txt

# Копируем проект (для запуска без volume)
COPY . /app

EXPOSE 8766

# Команду запуска переопределяем в docker-compose, но оставим дефолт
CMD ["bash","-lc","./scripts/run_api.sh"]
