#!/usr/bin/env bash
set -Eeuo pipefail
IFS=$'\n\t'

BASE="${HOME}/ai-agent/projects/local_smart_agent"
INBOX="${BASE}/tasks/inbox"
DONE="${BASE}/tasks/done"
FAILED="${BASE}/tasks/failed}"
LOG="${BASE}/logs/inbox_watcher.log"

mkdir -p "${INBOX}" "${DONE}" "${FAILED}" "$(dirname "${LOG}")"

log(){ printf '%s %s\n' "$(date +'%F %T')" "$*" | tee -a "${LOG}"; }

normalize_json(){
  # Нормализуем файл в stdout: добавим version, kind, params.count
  local f="$1"
  if command -v jq >/dev/null 2>&1; then
    jq -c '
      .version = (.version // 1)
      | .kind = (.kind // .task // "")
      | .params = (.params // {})
      | .params.count = (.params.count // .count // 1)
    ' "$f"
  else
    cat "$f"
  fi
}

process_file(){
  local f="$1"
  local norm kind count
  norm="$(normalize_json "$f" 2>>"${LOG}")" || { log "[watcher] bad json → $(basename "$f")"; mv -f "$f" "${FAILED}/"; return 1; }
  kind="$(printf '%s' "$norm" | jq -r '.kind // ""' 2>>"${LOG}" || echo "")"
  count="$(printf '%s' "$norm" | jq -r '.params.count // 1' 2>>"${LOG}" || echo 1)"

  if [ -z "$kind" ] || [ "$kind" = "null" ]; then
    log "[watcher] unsupported (no kind) → $(basename "$f")"
    mv -f "$f" "${FAILED}/"; return 1
  fi

  case "$kind" in
    report_pack)
      log "[watcher] report_pack (count=${count}) ← $(basename "$f")"
      if "${BASE}/bin/report_pack.sh"; then
        mv -f "$f" "${DONE}/"
        log "[watcher] done → $(basename "$f")"
      else
        mv -f "$f" "${FAILED}/"
        log "[watcher] FAIL report_pack → $(basename "$f")"
        return 1
      fi
      ;;
    *)
      log "[watcher] unsupported kind='${kind}' → $(basename "$f")"
      mv -f "$f" "${FAILED}/"; return 1
      ;;
  esac
}

log "[watcher] start pid=$$"
while true; do
  shopt -s nullglob
  for f in "${INBOX}"/*.json; do
    lock="${f}.lock"
    if ( set -o noclobber; : > "$lock" ) 2>/dev/null; then
      trap 'rm -f "$lock"' RETURN
      process_file "$f" || true
      rm -f "$lock"; trap - RETURN
    fi
  done
  sleep 1
done
