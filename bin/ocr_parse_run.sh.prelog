#!/usr/bin/env bash
# мягкий режим: не роняем терминал, логи в logs/ocr_parse.log
set -u
IFS=$'\n\t'

ROOT="/home/andrei-work/ai-agent/projects/local_smart_agent"
LOG="$ROOT/logs/ocr_parse.log"
PY="$ROOT/bin/ocr_parse_min.py"

log(){ printf "%s %s\n" "[$(date -Iseconds)]" "$*" | tee -a "$LOG"; }

parse_one(){
  local d="$1"
  if [[ ! -d "$d" ]]; then log "[FAIL] not a dir: $d"; return 1; fi
  log "[RUN] $d"
  if python3 "$PY" "$d" >>"$LOG" 2>&1; then
    log "[OK] parsed → $d/parsed.json"
  else
    log "[FAIL] parse → $d"
  fi
}

main(){
  mkdir -p "$(dirname "$LOG")"
  if [[ $# -ge 1 ]]; then
    parse_one "$1"
  else
    # по умолчанию один последний отчёт
    if ls -1d "$ROOT/reports/ocr/"* >/dev/null 2>&1; then
      local last; last="$(ls -1dt "$ROOT/reports/ocr/"* | head -n 1)"
      parse_one "$last"
    else
      log "[INFO] нет папок reports/ocr/*"
    fi
  fi
}

main "$@"
