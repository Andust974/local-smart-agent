#!/usr/bin/env bash
# мягкий режим — не роняем терминал
set -u
IFS=$'\n\t'

ROOT="/home/andrei-work/ai-agent/projects/local_smart_agent"
LOG="$ROOT/logs/ocr_norm.log"
PY="$ROOT/bin/ocr_normalize.py"

log(){ printf "%s %s\n" "[$(date -Iseconds)]" "$*" | tee -a "$LOG"; }

norm_one(){
  local rep="$1"
  local txt="$rep/text.txt"
  [[ -f "$txt" ]] || { log "[SKIP] нет text.txt → $rep"; return 0; }
  log "[RUN] $rep"
  if python3 "$PY" "$txt" >>"$LOG" 2>&1; then
    log "[OK] normalized → $rep/normalized.txt"
  else
    log "[FAIL] normalize → $rep"
  fi
}

main(){
  mkdir -p "$(dirname "$LOG")"
  if [[ $# -ge 1 ]]; then
    norm_one "$1"
  else
    # по умолчанию — 1 последний отчёт (микрошаг)
    if ls -1d "$ROOT/reports/ocr/"* >/dev/null 2>&1; then
      local last; last="$(ls -1dt "$ROOT/reports/ocr/"* | head -n 1)"
      norm_one "$last"
    else
      log "[INFO] нет папок reports/ocr/* — нечего нормализовать"
    fi
  fi
}

main "$@"
