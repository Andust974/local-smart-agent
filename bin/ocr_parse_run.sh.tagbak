#!/usr/bin/env bash
# patched for unified logging
set -u
IFS=$'\n\t'
ROOT="/home/andrei-work/ai-agent/projects/local_smart_agent"
LOG="$ROOT/logs/ocr_parse.log"
PY="$ROOT/bin/ocr_parse_min.py"
OCR_TAG="ocr-prod"; OCR_LOG="$LOG"; source "$ROOT/bin/ocr_log.sh" 2>/dev/null || true

parse_one(){
  local d="$1"
  if [[ ! -d "$d" ]]; then log_fail "[FAIL] not a dir: $d"; return 2; fi
  log_info "[RUN] parse → $d"
  if python3 "$PY" "$d" >>"$LOG" 2>&1; then
    log_ok   "[OK] parsed  → $d/parsed.json"; return 0
  else
    log_fail "[FAIL] parse  → $d"; return 1
  fi
}

main(){
  mkdir -p "$(dirname "$LOG")"
  if [[ $# -ge 1 ]]; then
    parse_one "$1"; exit $?
  else
    if ls -1d "$ROOT/reports/ocr/"* >/dev/null 2>&1; then
      local last; last="$(ls -1dt "$ROOT/reports/ocr/"* | head -n 1)"
      parse_one "$last"; exit $?
    else
      log_info "[INFO] no reports/ocr/*"; exit 0
    fi
  fi
}
main "$@"
