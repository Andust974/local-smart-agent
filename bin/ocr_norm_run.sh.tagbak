#!/usr/bin/env bash
# patched for unified logging
set -u
IFS=$'\n\t'
ROOT="/home/andrei-work/ai-agent/projects/local_smart_agent"
LOG="$ROOT/logs/ocr_norm.log"
PY="$ROOT/bin/ocr_normalize.py"
OCR_TAG="ocr-prod"; OCR_LOG="$LOG"; source "$ROOT/bin/ocr_log.sh" 2>/dev/null || true

norm_one(){
  local rep="$1"
  local txt="$rep/text.txt"
  if [[ ! -f "$txt" ]]; then log_info "[SKIP] no text.txt → $rep"; return 0; fi
  log_info "[RUN] normalize → $rep"
  if python3 "$PY" "$txt" >>"$LOG" 2>&1; then
    log_ok   "[OK] normalized → $rep/normalized.txt"; return 0
  else
    log_fail "[FAIL] normalize → $rep"; return 1
  fi
}

main(){
  mkdir -p "$(dirname "$LOG")"
  if [[ $# -ge 1 ]]; then
    norm_one "$1"; exit $?
  else
    if ls -1d "$ROOT/reports/ocr/"* >/dev/null 2>&1; then
      local last; last="$(ls -1dt "$ROOT/reports/ocr/"* | head -n 1)"
      norm_one "$last"; exit $?
    else
      log_info "[INFO] no reports/ocr/*"
      exit 0
    fi
  fi
}
main "$@"
