#!/usr/bin/env bash
# Заглушка task_runner
echo "[task_runner] ⚠️ placeholder — not implemented yet"
# exit 0 # disabled by patch

__handler_text_summary() {
  local json="$1"
  local inp outp ts
  ts="$(date +%Y%m%d_%H%M%S)"
  inp="$(echo "$json" | jq -r '.txt')"
  if [ -z "${inp:-}" ] || [ ! -f "$inp" ]; then
    echo "[text_summary] ERR: no file: $inp" >&2
    return 1
  fi
  outp="$HOME/ai-agent/projects/local_smart_agent/reports/extra/summary_${ts}.txt"
  "$HOME/ai-agent/projects/local_smart_agent/skills/extra/text_summary.py" "$inp" "$outp"
  [ -f "$outp" ] && echo "$outp"
}

__handler_word_count() {
  local json="$1"
  local inp outp ts
  ts="$(date +%Y%m%d_%H%M%S)"
  inp="$(echo "$json" | jq -r '.txt')"
  if [ -z "${inp:-}" ] || [ ! -f "$inp" ]; then
    echo "[word_count] ERR: no file: $inp" >&2
    return 1
  fi
  outp="$HOME/ai-agent/projects/local_smart_agent/reports/extra/stats_${ts}.json"
  "$HOME/ai-agent/projects/local_smart_agent/skills/extra/word_count.py" "$inp" "$outp"
  [ -f "$outp" ] && echo "$outp"
}

__handler_merge_txt() {
  local json="$1"
  local outp ts inps
  ts="$(date +%Y%m%d_%H%M%S)"
  outp="$HOME/ai-agent/projects/local_smart_agent/reports/extra/merged_${ts}.txt"
  inps="$(echo "$json" | jq -r '.inputs[]?')"
  "$HOME/ai-agent/projects/local_smart_agent/skills/extra/merge_txt.py" "$outp" $inps
  [ -f "$outp" ] && echo "$outp"
}

# нормализация полей type/kind

if echo "$json" | jq -e ".kind" >/dev/null 2>&1; then

  type=$(echo "$json" | jq -r ".kind")

else

  type=$(echo "$json" | jq -r ".type")

fi

# === Dispatch by task type ===
case $type in
  text_summary)
    __handler_text_summary "$json"
    ;;
  word_count)
    __handler_word_count "$json"
    ;;
  merge_txt)
    __handler_merge_txt "$json"
    ;;
  report_pack)
    __handler_report_pack "$json"
    ;;
  *)
    echo "[runner] unsupported type: $type" >&2
    ;;
esac

# === ENTRYPOINT ===
json=""
if [ -n "${1:-}" ] && [ -f "$1" ]; then
  json="$(cat "$1")"
else
  # читаем из stdin, если файл не передан
  if [ -t 0 ]; then
    echo "[runner] no input json file" >&2
    exit 1
  else
    json="$(cat)"
  fi
fi

# нормализация полей type/kind
if echo "$json" | jq -e ".kind" >/dev/null 2>&1; then
  type=$(echo "$json" | jq -r ".kind")
else
  type=$(echo "$json" | jq -r ".type")
fi

# если переменная type пустая — ошибка
if [ -z "${type:-}" ] || [ "${type}" = "null" ]; then
  echo "[runner] unsupported (no kind/type)" >&2
  exit 2
fi

# запускаем dispatch (должен быть добавлен ранее)
# === Dispatch by task type ===
